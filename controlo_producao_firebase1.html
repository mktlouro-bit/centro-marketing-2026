<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Controlo Produ√ß√£o">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%232c3e50' width='100' height='100'/><text y='75' font-size='80' fill='white' text-anchor='middle' x='50'>üßÄ</text></svg>">
    <title>Controlo de Produ√ß√£o - Lactilouro - Queijos Dom Villas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            border-radius: 8px 8px 0 0;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .firebase-config-alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            margin: 20px;
            border-radius: 6px;
            display: none;
        }

        .firebase-config-alert.show {
            display: block;
        }

        .firebase-config-alert h3 {
            margin-bottom: 10px;
            color: #856404;
        }

        .firebase-config-alert code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #dc3545;
        }

        .connection-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .connection-status.connected .dot {
            background: #28a745;
        }

        .connection-status.disconnected .dot {
            background: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .tabs {
            display: flex;
            background: #34495e;
            border-bottom: 3px solid #2c3e50;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
        }

        .tab:hover {
            background: #2c3e50;
        }

        .tab.active {
            background: white;
            color: #2c3e50;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 14px;
        }

        input, select, textarea {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .ph-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .ph-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .ph-ok {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .filter-section {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .data-table th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 13px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table .ph-ok-cell {
            background-color: #d4edda;
            color: #155724;
            font-weight: 600;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-top: 5px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
            font-size: 16px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
            display: none;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        #fermentoOutro, #producaoOutro {
            display: none;
        }

        .shared-indicator {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
            padding: 12px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .comparison-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin: 30px 0;
            border-left: 4px solid #e74c3c;
        }

        .comparison-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .comparison-table {
            width: 100%;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .comparison-table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }

        .comparison-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .comparison-table .metric-name {
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
        }

        .ph-ok-col {
            background: #d4edda;
        }

        .ph-nok-col {
            background: #f8d7da;
        }

        .diff-positive {
            color: #27ae60;
            font-weight: 600;
        }

        .diff-negative {
            color: #e74c3c;
            font-weight: 600;
        }

        .install-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .install-banner.show {
            display: flex;
        }

        .install-text {
            flex: 1;
        }

        .install-text strong {
            display: block;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .install-text small {
            opacity: 0.9;
        }

        .btn-install {
            background: white;
            color: #667eea;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            white-space: nowrap;
        }

        .btn-install:hover {
            background: #f0f0f0;
        }

        @media (max-width: 768px) {
            .install-banner {
                flex-direction: column;
                text-align: center;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }

            .connection-status {
                top: 10px;
                right: 10px;
                font-size: 11px;
                padding: 8px 12px;
            }
        }

        .draft-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .draft-card {
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }

        .draft-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .draft-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .draft-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }

        .draft-badge {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .draft-info {
            font-size: 13px;
            color: #7f8c8d;
            margin: 8px 0;
        }

        .draft-info strong {
            color: #2c3e50;
        }

        .draft-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-draft-continue {
            flex: 1;
            background: #3498db;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-draft-continue:hover {
            background: #2980b9;
        }

        .btn-draft-delete {
            background: #e74c3c;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-draft-delete:hover {
            background: #c0392b;
        }

        .draft-time {
            font-size: 11px;
            color: #95a5a6;
            margin-top: 10px;
            font-style: italic;
        }

        .empty-drafts {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }

        .empty-drafts-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .current-draft-indicator {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .current-draft-indicator.show {
            display: flex;
        }

        .btn-cancel-draft {
            background: #6c757d;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="install-banner" id="installBanner">
        <div class="install-text">
            <strong>üì± Instalar App</strong>
            <small>Instale esta aplica√ß√£o no seu dispositivo para acesso r√°pido e offline</small>
        </div>
        <button class="btn-install" id="installButton">Instalar</button>
    </div>

    <div class="connection-status disconnected" id="connectionStatus">
        <span class="dot"></span>
        <span id="statusText">A conectar...</span>
    </div>

    <div class="firebase-config-alert" id="configAlert">
        <h3>‚öôÔ∏è Configura√ß√£o Firebase Necess√°ria</h3>
        <p>Por favor, edite este ficheiro e adicione a sua configura√ß√£o Firebase no script no final do ficheiro.</p>
        <p>Procure por <code>// CONFIGURA√á√ÉO FIREBASE</code> e substitua pelos seus valores.</p>
        <p>Veja o ficheiro <strong>GUIA_FIREBASE.md</strong> para instru√ß√µes detalhadas.</p>
    </div>

    <div class="container">
        <header>
            <h1>Sistema de Controlo de Produ√ß√£o</h1>
            <div class="subtitle">Lactilouro - Queijos Dom Villas</div>
        </header>

        <div class="tabs">
            <div class="tab active" onclick="showTab('registo')">üìù Registo de Dados</div>
            <div class="tab" onclick="showTab('progresso')">‚è≥ Registos em Progresso</div>
            <div class="tab" onclick="showTab('consulta')">üìä Consulta de Dados</div>
            <div class="tab" onclick="showTab('analise')">üìà An√°lise e Gr√°ficos</div>
        </div>

        <!-- TAB 1: REGISTO -->
        <div id="registo" class="tab-content active">
            <div class="shared-indicator">
                üåê <strong>Dados Sincronizados em Tempo Real:</strong> Todos os registos s√£o partilhados e vis√≠veis em todos os dispositivos conectados!
            </div>

            <div class="current-draft-indicator" id="currentDraftIndicator">
                <span>‚è≥ <strong>A editar:</strong> <span id="currentDraftName"></span></span>
                <button class="btn-cancel-draft" onclick="cancelCurrentDraft()">Cancelar e Criar Novo</button>
            </div>

            <div class="success-message" id="successMessage">
                ‚úì Dados gravados e sincronizados com sucesso!
            </div>

            <form id="dataForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="data">Data *</label>
                        <input type="date" id="data" required>
                    </div>

                    <div class="form-group">
                        <label for="tanque">Tanque de Leite *</label>
                        <select id="tanque" required>
                            <option value="">Selecione...</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="receita">Receita *</label>
                        <select id="receita" required>
                            <option value="">Selecione...</option>
                            <option value="Flamengo">Flamengo</option>
                            <option value="Light">Light</option>
                            <option value="Sem Lactose">Sem Lactose</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="producao">Produ√ß√£o *</label>
                        <select id="producao" required onchange="toggleProducaoOutro()">
                            <option value="">Selecione...</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>

                    <div class="form-group" id="producaoOutro">
                        <label for="producaoOutroTexto">Especificar Produ√ß√£o</label>
                        <input type="text" id="producaoOutroTexto" placeholder="Digite a produ√ß√£o">
                    </div>

                    <div class="form-group">
                        <label for="gordura">Gordura Leite Cru (%) *</label>
                        <input type="number" id="gordura" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="proteina">Prote√≠na Leite Cru (%) *</label>
                        <input type="number" id="proteina" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="racio">R√°cio</label>
                        <select id="racio">
                            <option value="">Selecione...</option>
                            <option value="Inteiro">Inteiro</option>
                            <option value="R√°cio 20%">R√°cio 20%</option>
                            <option value="R√°cio 30%">R√°cio 30%</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="fermento">Fermento *</label>
                        <select id="fermento" required onchange="toggleFermentoOutro()">
                            <option value="">Selecione...</option>
                            <option value="111">111</option>
                            <option value="112">112</option>
                            <option value="113">113</option>
                            <option value="225">225</option>
                            <option value="226">226</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>

                    <div class="form-group" id="fermentoOutro">
                        <label for="fermentoOutroTexto">Especificar Fermento</label>
                        <input type="text" id="fermentoOutroTexto" placeholder="Digite o fermento">
                    </div>

                    <div class="form-group">
                        <label for="tempCoagulacao">Temperatura Coagula√ß√£o (¬∞C) *</label>
                        <input type="number" id="tempCoagulacao" step="0.1" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="tempLavagem">Temperatura Lavagem (¬∞C) *</label>
                        <input type="number" id="tempLavagem" step="0.1" min="0" required>
                    </div>

                    <div class="form-group">
                        <label>PH *</label>
                        <div class="ph-checkbox">
                            <input type="checkbox" id="phOk" onchange="togglePH()">
                            <label for="phOk" style="margin: 0; font-weight: normal;">OK</label>
                        </div>
                        <input type="text" id="phValor" placeholder="Valor do PH" required>
                    </div>

                    <div class="form-group">
                        <label for="ph1">Valor PH1</label>
                        <input type="text" id="ph1" placeholder="Valor PH1 (opcional)">
                    </div>

                    <div class="form-group">
                        <label for="ph2">Valor PH2</label>
                        <input type="text" id="ph2" placeholder="Valor PH2 (opcional)">
                    </div>

                    <div class="form-group">
                        <label for="ph3">Valor PH3</label>
                        <input type="text" id="ph3" placeholder="Valor PH3 (opcional)">
                    </div>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-success" onclick="saveDraft()">üíæ Guardar Rascunho</button>
                    <button type="button" class="btn btn-success" onclick="saveDraftAndNew()" style="background: #16a085;">üíæ‚ûï Guardar e Criar Novo</button>
                    <button type="submit" class="btn btn-primary">‚úÖ Gravar e Finalizar</button>
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">üîÑ Limpar Formul√°rio</button>
                </div>
            </form>
        </div>

        <!-- TAB 2: REGISTOS EM PROGRESSO -->
        <div id="progresso" class="tab-content">
            <div style="margin-bottom: 20px;">
                <h3 style="color: #2c3e50;">‚è≥ Registos em Progresso</h3>
                <p style="color: #7f8c8d; margin-top: 10px;">
                    Aqui pode retomar o preenchimento de registos que guardou como rascunho. 
                    √ötil quando est√° a preencher v√°rias cubas em simult√¢neo.
                </p>
            </div>
            <div id="draftsContainer"></div>
        </div>

        <!-- TAB 3: CONSULTA -->
        <div id="consulta" class="tab-content">
            <div class="filter-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Filtros de Pesquisa</h3>
                <div class="filter-grid">
                    <div class="form-group">
                        <label for="filterDataInicio">Data In√≠cio</label>
                        <input type="date" id="filterDataInicio">
                    </div>
                    <div class="form-group">
                        <label for="filterDataFim">Data Fim</label>
                        <input type="date" id="filterDataFim">
                    </div>
                    <div class="form-group">
                        <label for="filterTanque">Tanque</label>
                        <select id="filterTanque">
                            <option value="">Todos</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterReceita">Receita</label>
                        <select id="filterReceita">
                            <option value="">Todas</option>
                            <option value="Flamengo">Flamengo</option>
                            <option value="Light">Light</option>
                            <option value="Sem Lactose">Sem Lactose</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success" onclick="loadTableData()">üîç Aplicar Filtros</button>
            </div>

            <div id="tableContainer"></div>
        </div>

        <!-- TAB 3: AN√ÅLISE -->
        <div id="analise" class="tab-content">
            <div class="filter-section">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">Per√≠odo de An√°lise</h3>
                <div class="filter-grid">
                    <div class="form-group">
                        <label for="analysisDataInicio">Data In√≠cio</label>
                        <input type="date" id="analysisDataInicio">
                    </div>
                    <div class="form-group">
                        <label for="analysisDataFim">Data Fim</label>
                        <input type="date" id="analysisDataFim">
                    </div>
                    <div class="form-group">
                        <label for="analysisTanque">Tanque</label>
                        <select id="analysisTanque">
                            <option value="">Todos</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="analysisReceita">Receita</label>
                        <select id="analysisReceita">
                            <option value="">Todas</option>
                            <option value="Flamengo">Flamengo</option>
                            <option value="Light">Light</option>
                            <option value="Sem Lactose">Sem Lactose</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success" onclick="generateAnalysis()">üìä Gerar An√°lise</button>
            </div>

            <div id="statsContainer"></div>
            <div id="chartsContainer"></div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURA√á√ÉO FIREBASE
        // ========================================
        // IMPORTANTE: Substitua os valores abaixo pela sua configura√ß√£o Firebase
        // Veja o ficheiro GUIA_FIREBASE.md para instru√ß√µes
        
        const firebaseConfig = {
            apiKey: "AIzaSyBUdUJiFtH_Axct5UXN9WErYbaB-o5WFX0",
            authDomain: "lactilouro-producao.firebaseapp.com",
            databaseURL: "https://lactilouro-producao-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "lactilouro-producao",
            storageBucket: "lactilouro-producao.firebasestorage.app",
            messagingSenderId: "530914223930",
            appId: "1:530914223930:web:e9e8d922d65cb31e525203"
        };

        // ========================================
        // INICIALIZA√á√ÉO
        // ========================================
        
        let database;
        let allData = [];
        let allDrafts = [];
        let chartInstances = {};
        let isFirebaseConfigured = false;
        let currentDraftId = null;

        // Verificar se Firebase est√° configurado
        function checkFirebaseConfig() {
            if (firebaseConfig.apiKey === "SUA_API_KEY_AQUI") {
                document.getElementById('configAlert').classList.add('show');
                document.getElementById('statusText').textContent = 'Firebase n√£o configurado';
                return false;
            }
            return true;
        }

        // Inicializar Firebase
        function initFirebase() {
            if (!checkFirebaseConfig()) return;

            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseConfigured = true;
                
                // Escutar mudan√ßas de conex√£o
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snap) => {
                    const status = document.getElementById('connectionStatus');
                    const statusText = document.getElementById('statusText');
                    
                    if (snap.val() === true) {
                        status.className = 'connection-status connected';
                        statusText.textContent = 'Conectado - Dados sincronizados';
                    } else {
                        status.className = 'connection-status disconnected';
                        statusText.textContent = 'Offline - Reconectando...';
                    }
                });

                // Escutar mudan√ßas nos dados em tempo real
                database.ref('producao').on('value', (snapshot) => {
                    allData = [];
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            allData.push(childSnapshot.val());
                        });
                    }
                    allData.sort((a, b) => new Date(b.data) - new Date(a.data));
                    
                    // Atualizar tabela se estiver na aba consulta
                    if (document.getElementById('consulta').classList.contains('active')) {
                        loadTableData();
                    }
                });

                // Escutar mudan√ßas nos drafts
                database.ref('drafts').on('value', (snapshot) => {
                    allDrafts = [];
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            allDrafts.push(childSnapshot.val());
                        });
                    }
                    allDrafts.sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));
                    
                    // Atualizar lista de drafts se estiver na aba progresso
                    if (document.getElementById('progresso').classList.contains('active')) {
                        loadDrafts();
                    }
                });

            } catch (error) {
                console.error('Erro ao inicializar Firebase:', error);
                document.getElementById('configAlert').classList.add('show');
                document.getElementById('statusText').textContent = 'Erro na configura√ß√£o';
            }
        }

        // Carregar ao iniciar
        window.addEventListener('load', () => {
            initFirebase();
            document.getElementById('data').valueAsDate = new Date();
            
            // Registar service worker para PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(() => console.log('Service Worker registado'))
                    .catch((error) => console.log('Service Worker falhou:', error));
            }
        });

        // ========================================
        // PWA - INSTALA√á√ÉO
        // ========================================
        
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBanner').classList.add('show');
        });

        document.getElementById('installButton').addEventListener('click', async () => {
            if (!deferredPrompt) {
                alert('Para instalar:\n\nAndroid Chrome: Menu (‚ãÆ) ‚Üí "Adicionar ao ecr√£ principal"\n\niOS Safari: Bot√£o Partilhar ‚Üí "Adicionar ao Ecr√£ Principal"');
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('App instalada');
            }
            
            deferredPrompt = null;
            document.getElementById('installBanner').classList.remove('show');
        });

        window.addEventListener('appinstalled', () => {
            document.getElementById('installBanner').classList.remove('show');
        });

        setTimeout(() => {
            if (!deferredPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
                document.getElementById('installBanner').classList.add('show');
            }
        }, 3000);

        // ========================================
        // FUN√á√ïES DE FORMUL√ÅRIO
        // ========================================

        function toggleFermentoOutro() {
            const fermento = document.getElementById('fermento').value;
            const fermentoOutro = document.getElementById('fermentoOutro');
            if (fermento === 'outro') {
                fermentoOutro.style.display = 'block';
                document.getElementById('fermentoOutroTexto').required = true;
            } else {
                fermentoOutro.style.display = 'none';
                document.getElementById('fermentoOutroTexto').required = false;
            }
        }

        function toggleProducaoOutro() {
            const producao = document.getElementById('producao').value;
            const producaoOutro = document.getElementById('producaoOutro');
            if (producao === 'outro') {
                producaoOutro.style.display = 'block';
                document.getElementById('producaoOutroTexto').required = true;
            } else {
                producaoOutro.style.display = 'none';
                document.getElementById('producaoOutroTexto').required = false;
            }
        }

        function togglePH() {
            const phOk = document.getElementById('phOk').checked;
            const phValor = document.getElementById('phValor');
            
            if (phOk) {
                phValor.value = 'OK';
                phValor.classList.add('ph-ok');
                phValor.readOnly = true;
            } else {
                phValor.value = '';
                phValor.classList.remove('ph-ok');
                phValor.readOnly = false;
            }
        }

        function clearForm() {
            document.getElementById('dataForm').reset();
            document.getElementById('data').valueAsDate = new Date();
            document.getElementById('phValor').classList.remove('ph-ok');
            document.getElementById('fermentoOutro').style.display = 'none';
            document.getElementById('producaoOutro').style.display = 'none';
            document.getElementById('ph1').value = '';
            document.getElementById('ph2').value = '';
            document.getElementById('ph3').value = '';
            currentDraftId = null;
            document.getElementById('currentDraftIndicator').classList.remove('show');
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'consulta') {
                loadTableData();
            } else if (tabName === 'progresso') {
                loadDrafts();
            }
        }

        // ========================================
        // GRAVAR DADOS NO FIREBASE
        // ========================================

        document.getElementById('dataForm').addEventListener('submit', (e) => {
            e.preventDefault();

            if (!isFirebaseConfigured) {
                alert('Firebase n√£o est√° configurado. Por favor, configure primeiro.');
                return;
            }

            const fermento = document.getElementById('fermento').value;
            const fermentoValue = fermento === 'outro' 
                ? document.getElementById('fermentoOutroTexto').value 
                : fermento;

            const producao = document.getElementById('producao').value;
            const producaoValue = producao === 'outro' 
                ? document.getElementById('producaoOutroTexto').value 
                : producao;

            const newData = {
                id: currentDraftId || Date.now().toString(),
                data: document.getElementById('data').value,
                tanque: document.getElementById('tanque').value,
                receita: document.getElementById('receita').value,
                producao: producaoValue,
                gordura: parseFloat(document.getElementById('gordura').value),
                proteina: parseFloat(document.getElementById('proteina').value),
                racio: document.getElementById('racio').value || '',
                fermento: fermentoValue,
                tempCoagulacao: parseFloat(document.getElementById('tempCoagulacao').value),
                tempLavagem: parseFloat(document.getElementById('tempLavagem').value),
                ph: document.getElementById('phValor').value,
                ph1: document.getElementById('ph1').value || '',
                ph2: document.getElementById('ph2').value || '',
                ph3: document.getElementById('ph3').value || '',
                timestamp: new Date().toISOString(),
                status: 'completo'
            };

            // Gravar no Firebase
            database.ref('producao/' + newData.id).set(newData)
                .then(() => {
                    // Se era um draft, eliminar da sec√ß√£o de drafts
                    if (currentDraftId) {
                        database.ref('drafts/' + currentDraftId).remove();
                        currentDraftId = null;
                        document.getElementById('currentDraftIndicator').classList.remove('show');
                    }

                    // Mostrar mensagem de sucesso
                    const successMsg = document.getElementById('successMessage');
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 3000);

                    // Limpar formul√°rio
                    clearForm();
                })
                .catch((error) => {
                    alert('Erro ao gravar dados: ' + error.message);
                });
        });

        // ========================================
        // ELIMINAR REGISTO
        // ========================================

        function deleteRecord(id) {
            if (!confirm('Tem certeza que deseja eliminar este registo?')) return;

            if (!isFirebaseConfigured) {
                alert('Firebase n√£o est√° configurado.');
                return;
            }

            database.ref('producao/' + id).remove()
                .then(() => {
                    alert('Registo eliminado com sucesso!');
                })
                .catch((error) => {
                    alert('Erro ao eliminar registo: ' + error.message);
                });
        }

        // ========================================
        // GEST√ÉO DE DRAFTS (RASCUNHOS)
        // ========================================

        function saveDraft() {
            if (!isFirebaseConfigured) {
                alert('Firebase n√£o est√° configurado. Por favor, configure primeiro.');
                return;
            }

            const fermento = document.getElementById('fermento').value;
            const fermentoValue = fermento === 'outro' 
                ? document.getElementById('fermentoOutroTexto').value 
                : fermento;

            const producao = document.getElementById('producao').value;
            const producaoValue = producao === 'outro' 
                ? document.getElementById('producaoOutroTexto').value 
                : producao;

            // Criar identificador do draft baseado no tanque e data
            const tanque = document.getElementById('tanque').value;
            const data = document.getElementById('data').value;
            const receita = document.getElementById('receita').value;
            
            const draftName = `${receita ? receita : 'Receita'} - Tanque ${tanque || '?'} - ${data || new Date().toLocaleDateString('pt-PT')}`;

            // Verificar se est√° a atualizar um draft existente ou criar novo
            const isUpdatingExisting = currentDraftId && allDrafts.some(d => d.id === currentDraftId);
            const draftId = isUpdatingExisting ? currentDraftId : Date.now().toString();

            const draftData = {
                id: draftId,
                draftName: draftName,
                data: data,
                tanque: tanque,
                receita: receita,
                producao: producaoValue,
                gordura: document.getElementById('gordura').value,
                proteina: document.getElementById('proteina').value,
                racio: document.getElementById('racio').value,
                fermento: fermentoValue,
                tempCoagulacao: document.getElementById('tempCoagulacao').value,
                tempLavagem: document.getElementById('tempLavagem').value,
                ph: document.getElementById('phValor').value,
                phOk: document.getElementById('phOk').checked,
                ph1: document.getElementById('ph1').value,
                ph2: document.getElementById('ph2').value,
                ph3: document.getElementById('ph3').value,
                fermentoOutro: document.getElementById('fermentoOutroTexto').value,
                producaoOutro: document.getElementById('producaoOutroTexto').value,
                lastModified: new Date().toISOString(),
                status: 'rascunho'
            };

            database.ref('drafts/' + draftData.id).set(draftData)
                .then(() => {
                    // Se estava a atualizar um draft existente, manter o currentDraftId
                    // Se criou um novo, N√ÉO manter (para pr√≥ximo rascunho ser novo tamb√©m)
                    if (!isUpdatingExisting) {
                        currentDraftId = null;
                        document.getElementById('currentDraftIndicator').classList.remove('show');
                    } else {
                        currentDraftId = draftId;
                        document.getElementById('currentDraftIndicator').classList.add('show');
                        document.getElementById('currentDraftName').textContent = draftName;
                    }

                    // Mostrar mensagem
                    const successMsg = document.getElementById('successMessage');
                    if (isUpdatingExisting) {
                        successMsg.innerHTML = 'üíæ Rascunho atualizado!';
                    } else {
                        successMsg.innerHTML = 'üíæ Novo rascunho guardado! Pode preencher outro registo.';
                    }
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                        successMsg.innerHTML = '‚úì Dados gravados e sincronizados com sucesso!';
                    }, 3000);

                    // Se criou novo rascunho, limpar formul√°rio para facilitar pr√≥ximo registo
                    if (!isUpdatingExisting) {
                        clearForm();
                    }
                })
                .catch((error) => {
                    alert('Erro ao guardar rascunho: ' + error.message);
                });
        }

        function saveDraftAndNew() {
            if (!isFirebaseConfigured) {
                alert('Firebase n√£o est√° configurado. Por favor, configure primeiro.');
                return;
            }

            const fermento = document.getElementById('fermento').value;
            const fermentoValue = fermento === 'outro' 
                ? document.getElementById('fermentoOutroTexto').value 
                : fermento;

            const producao = document.getElementById('producao').value;
            const producaoValue = producao === 'outro' 
                ? document.getElementById('producaoOutroTexto').value 
                : producao;

            const tanque = document.getElementById('tanque').value;
            const data = document.getElementById('data').value;
            const receita = document.getElementById('receita').value;
            
            const draftName = `${receita ? receita : 'Receita'} - Tanque ${tanque || '?'} - ${data || new Date().toLocaleDateString('pt-PT')}`;

            // SEMPRE criar um novo draft (mesmo se estava a editar outro)
            const draftId = Date.now().toString();

            const draftData = {
                id: draftId,
                draftName: draftName,
                data: data,
                tanque: tanque,
                receita: receita,
                producao: producaoValue,
                gordura: document.getElementById('gordura').value,
                proteina: document.getElementById('proteina').value,
                racio: document.getElementById('racio').value,
                fermento: fermentoValue,
                tempCoagulacao: document.getElementById('tempCoagulacao').value,
                tempLavagem: document.getElementById('tempLavagem').value,
                ph: document.getElementById('phValor').value,
                phOk: document.getElementById('phOk').checked,
                ph1: document.getElementById('ph1').value,
                ph2: document.getElementById('ph2').value,
                ph3: document.getElementById('ph3').value,
                fermentoOutro: document.getElementById('fermentoOutroTexto').value,
                producaoOutro: document.getElementById('producaoOutroTexto').value,
                lastModified: new Date().toISOString(),
                status: 'rascunho'
            };

            database.ref('drafts/' + draftData.id).set(draftData)
                .then(() => {
                    // SEMPRE limpar para criar novo
                    currentDraftId = null;
                    document.getElementById('currentDraftIndicator').classList.remove('show');

                    // Mostrar mensagem
                    const successMsg = document.getElementById('successMessage');
                    successMsg.innerHTML = 'üíæ Rascunho guardado! Formul√°rio limpo para nova cuba.';
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                        successMsg.innerHTML = '‚úì Dados gravados e sincronizados com sucesso!';
                    }, 3000);

                    // Limpar formul√°rio
                    clearForm();
                })
                .catch((error) => {
                    alert('Erro ao guardar rascunho: ' + error.message);
                });
        }

        function loadDrafts() {
            const container = document.getElementById('draftsContainer');

            if (allDrafts.length === 0) {
                container.innerHTML = `
                    <div class="empty-drafts">
                        <div class="empty-drafts-icon">üìã</div>
                        <h3>Nenhum registo em progresso</h3>
                        <p>Quando guardar um registo como rascunho, ele aparecer√° aqui.</p>
                        <p style="margin-top: 20px;">
                            <strong>Como usar:</strong><br>
                            1. Preencha parcialmente um registo<br>
                            2. Clique "Guardar Rascunho"<br>
                            3. Volte aqui para continuar mais tarde
                        </p>
                    </div>
                `;
                return;
            }

            let html = '<div class="draft-cards">';

            allDrafts.forEach(draft => {
                const lastModified = new Date(draft.lastModified);
                const timeAgo = getTimeAgo(lastModified);
                
                // Calcular percentagem de campos preenchidos
                const totalFields = 13; // Total de campos principais
                let filledFields = 0;
                if (draft.data) filledFields++;
                if (draft.tanque) filledFields++;
                if (draft.receita) filledFields++;
                if (draft.producao) filledFields++;
                if (draft.gordura) filledFields++;
                if (draft.proteina) filledFields++;
                if (draft.racio) filledFields++;
                if (draft.fermento) filledFields++;
                if (draft.tempCoagulacao) filledFields++;
                if (draft.tempLavagem) filledFields++;
                if (draft.ph) filledFields++;
                
                const percentage = Math.round((filledFields / totalFields) * 100);

                html += `
                    <div class="draft-card">
                        <div class="draft-card-header">
                            <div class="draft-title">${draft.draftName}</div>
                            <div class="draft-badge">Rascunho</div>
                        </div>
                        <div class="draft-info">
                            <strong>Progresso:</strong> ${percentage}% preenchido (${filledFields}/${totalFields} campos)
                        </div>
                        ${draft.tanque ? `<div class="draft-info"><strong>Tanque:</strong> ${draft.tanque}</div>` : ''}
                        ${draft.receita ? `<div class="draft-info"><strong>Receita:</strong> ${draft.receita}</div>` : ''}
                        ${draft.producao ? `<div class="draft-info"><strong>Produ√ß√£o:</strong> ${draft.producao}</div>` : ''}
                        <div class="draft-time">Modificado ${timeAgo}</div>
                        <div class="draft-actions">
                            <button class="btn-draft-continue" onclick="continueDraft('${draft.id}')">
                                ‚úèÔ∏è Continuar
                            </button>
                            <button class="btn-draft-delete" onclick="deleteDraft('${draft.id}')">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function continueDraft(draftId) {
            const draft = allDrafts.find(d => d.id === draftId);
            if (!draft) return;

            // Preencher formul√°rio com dados do draft
            document.getElementById('data').value = draft.data || '';
            document.getElementById('tanque').value = draft.tanque || '';
            document.getElementById('receita').value = draft.receita || '';
            document.getElementById('gordura').value = draft.gordura || '';
            document.getElementById('proteina').value = draft.proteina || '';
            document.getElementById('racio').value = draft.racio || '';
            document.getElementById('tempCoagulacao').value = draft.tempCoagulacao || '';
            document.getElementById('tempLavagem').value = draft.tempLavagem || '';
            document.getElementById('phValor').value = draft.ph || '';
            document.getElementById('ph1').value = draft.ph1 || '';
            document.getElementById('ph2').value = draft.ph2 || '';
            document.getElementById('ph3').value = draft.ph3 || '';

            // Fermento
            if (draft.fermento && ['111', '112', '113', '225', '226'].includes(draft.fermento)) {
                document.getElementById('fermento').value = draft.fermento;
            } else if (draft.fermento) {
                document.getElementById('fermento').value = 'outro';
                document.getElementById('fermentoOutroTexto').value = draft.fermento;
                toggleFermentoOutro();
            }

            // Produ√ß√£o
            if (draft.producao && parseInt(draft.producao) >= 1 && parseInt(draft.producao) <= 15) {
                document.getElementById('producao').value = draft.producao;
            } else if (draft.producao) {
                document.getElementById('producao').value = 'outro';
                document.getElementById('producaoOutroTexto').value = draft.producao;
                toggleProducaoOutro();
            }

            // PH OK checkbox
            if (draft.phOk) {
                document.getElementById('phOk').checked = true;
                togglePH();
            }

            // Definir draft atual
            currentDraftId = draftId;
            document.getElementById('currentDraftIndicator').classList.add('show');
            document.getElementById('currentDraftName').textContent = draft.draftName;

            // Mudar para tab de registo
            showTab('registo');
            document.querySelector('.tab.active').classList.remove('active');
            document.querySelectorAll('.tab')[0].classList.add('active');

            // Scroll para o topo
            window.scrollTo(0, 0);
        }

        function deleteDraft(draftId) {
            if (!confirm('Tem certeza que deseja eliminar este rascunho?')) return;

            if (!isFirebaseConfigured) {
                alert('Firebase n√£o est√° configurado.');
                return;
            }

            database.ref('drafts/' + draftId).remove()
                .then(() => {
                    // Se era o draft atual, limpar
                    if (currentDraftId === draftId) {
                        cancelCurrentDraft();
                    }
                })
                .catch((error) => {
                    alert('Erro ao eliminar rascunho: ' + error.message);
                });
        }

        function cancelCurrentDraft() {
            currentDraftId = null;
            document.getElementById('currentDraftIndicator').classList.remove('show');
            clearForm();
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'h√° poucos segundos';
            if (seconds < 3600) return `h√° ${Math.floor(seconds / 60)} minutos`;
            if (seconds < 86400) return `h√° ${Math.floor(seconds / 3600)} horas`;
            if (seconds < 604800) return `h√° ${Math.floor(seconds / 86400)} dias`;
            
            return date.toLocaleDateString('pt-PT');
        }

        // ========================================
        // CARREGAR DADOS NA TABELA
        // ========================================

        function loadTableData() {
            const dataInicio = document.getElementById('filterDataInicio').value;
            const dataFim = document.getElementById('filterDataFim').value;
            const tanque = document.getElementById('filterTanque').value;
            const receita = document.getElementById('filterReceita').value;

            let filteredData = allData.filter(item => {
                let match = true;
                
                if (dataInicio && item.data < dataInicio) match = false;
                if (dataFim && item.data > dataFim) match = false;
                if (tanque && item.tanque !== tanque) match = false;
                if (receita && item.receita !== receita) match = false;
                
                return match;
            });

            const container = document.getElementById('tableContainer');

            if (filteredData.length === 0) {
                container.innerHTML = '<div class="no-data">Nenhum registo encontrado para os filtros selecionados.</div>';
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tanque</th>
                            <th>Receita</th>
                            <th>Produ√ß√£o</th>
                            <th>Gordura (%)</th>
                            <th>Prote√≠na (%)</th>
                            <th>R√°cio</th>
                            <th>Fermento</th>
                            <th>T. Coagula√ß√£o (¬∞C)</th>
                            <th>T. Lavagem (¬∞C)</th>
                            <th>PH</th>
                            <th>PH1</th>
                            <th>PH2</th>
                            <th>PH3</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            filteredData.forEach(item => {
                const phClass = item.ph === 'OK' ? 'ph-ok-cell' : '';
                const dataFormatada = new Date(item.data + 'T00:00:00').toLocaleDateString('pt-PT');
                
                html += `
                    <tr>
                        <td>${dataFormatada}</td>
                        <td>${item.tanque || '-'}</td>
                        <td>${item.receita}</td>
                        <td>${item.producao || '-'}</td>
                        <td>${item.gordura.toFixed(2)}</td>
                        <td>${item.proteina.toFixed(2)}</td>
                        <td>${item.racio || '-'}</td>
                        <td>${item.fermento}</td>
                        <td>${item.tempCoagulacao.toFixed(1)}</td>
                        <td>${item.tempLavagem.toFixed(1)}</td>
                        <td class="${phClass}">${item.ph}</td>
                        <td>${item.ph1 || '-'}</td>
                        <td>${item.ph2 || '-'}</td>
                        <td>${item.ph3 || '-'}</td>
                        <td><button class="delete-btn" onclick="deleteRecord('${item.id}')">üóëÔ∏è Eliminar</button></td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ========================================
        // AN√ÅLISE E GR√ÅFICOS
        // ========================================

        function generateAnalysis() {
            const dataInicio = document.getElementById('analysisDataInicio').value;
            const dataFim = document.getElementById('analysisDataFim').value;
            const tanque = document.getElementById('analysisTanque').value;
            const receita = document.getElementById('analysisReceita').value;

            let filteredData = allData.filter(item => {
                let match = true;
                if (dataInicio && item.data < dataInicio) match = false;
                if (dataFim && item.data > dataFim) match = false;
                if (tanque && item.tanque !== tanque) match = false;
                if (receita && item.receita !== receita) match = false;
                return match;
            });

            if (filteredData.length === 0) {
                document.getElementById('statsContainer').innerHTML = '<div class="no-data">Nenhum registo encontrado para an√°lise.</div>';
                document.getElementById('chartsContainer').innerHTML = '';
                return;
            }

            const stats = calculateStats(filteredData);
            displayStats(stats);
            displayCharts(filteredData);
        }

        function calculateStats(data) {
            const sum = (arr) => arr.reduce((a, b) => a + b, 0);
            const avg = (arr) => sum(arr) / arr.length;

            const gorduras = data.map(d => d.gordura);
            const proteinas = data.map(d => d.proteina);
            const tempsCoag = data.map(d => d.tempCoagulacao);
            const tempsLav = data.map(d => d.tempLavagem);

            return {
                totalRegistos: data.length,
                gorduraMedia: avg(gorduras),
                proteinaMedia: avg(proteinas),
                tempCoagMedia: avg(tempsCoag),
                tempLavMedia: avg(tempsLav),
                phOkCount: data.filter(d => d.ph === 'OK').length
            };
        }

        function displayStats(stats) {
            const html = `
                <div class="stats-grid">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="stat-label">Total Registos</div>
                        <div class="stat-value">${stats.totalRegistos}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="stat-label">Gordura M√©dia</div>
                        <div class="stat-value">${stats.gorduraMedia.toFixed(2)}%</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stat-label">Prote√≠na M√©dia</div>
                        <div class="stat-value">${stats.proteinaMedia.toFixed(2)}%</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="stat-label">T. Coagula√ß√£o M√©dia</div>
                        <div class="stat-value">${stats.tempCoagMedia.toFixed(1)}¬∞C</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <div class="stat-label">T. Lavagem M√©dia</div>
                        <div class="stat-value">${stats.tempLavMedia.toFixed(1)}¬∞C</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                        <div class="stat-label">PH OK</div>
                        <div class="stat-value">${stats.phOkCount} / ${stats.totalRegistos}</div>
                    </div>
                </div>
            `;
            document.getElementById('statsContainer').innerHTML = html;
        }

        function displayCharts(data) {
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};

            displayPHComparison(data);

            const container = document.getElementById('chartsContainer');
            container.innerHTML = `
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">Evolu√ß√£o de Gordura e Prote√≠na</div>
                        <canvas id="chartGorduraProteina"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Distribui√ß√£o por Receita</div>
                        <canvas id="chartReceitas"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Distribui√ß√£o por Tanque</div>
                        <canvas id="chartTanques"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Distribui√ß√£o por Produ√ß√£o</div>
                        <canvas id="chartProducao"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Temperaturas de Processo</div>
                        <canvas id="chartTemperaturas"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Distribui√ß√£o de Fermentos</div>
                        <canvas id="chartFermentos"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Distribui√ß√£o de R√°cios</div>
                        <canvas id="chartRacios"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Status PH</div>
                        <canvas id="chartPH"></canvas>
                    </div>
                </div>
            `;

            const sortedData = [...data].sort((a, b) => new Date(a.data) - new Date(b.data));

            // Gr√°fico 1: Gordura e Prote√≠na
            const ctx1 = document.getElementById('chartGorduraProteina').getContext('2d');
            chartInstances.gorduraProteina = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: sortedData.map(d => new Date(d.data + 'T00:00:00').toLocaleDateString('pt-PT')),
                    datasets: [{
                        label: 'Gordura (%)',
                        data: sortedData.map(d => d.gordura),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Prote√≠na (%)',
                        data: sortedData.map(d => d.proteina),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Gr√°fico 2: Receitas
            const receitaCount = {};
            data.forEach(d => {
                receitaCount[d.receita] = (receitaCount[d.receita] || 0) + 1;
            });

            const ctx2 = document.getElementById('chartReceitas').getContext('2d');
            chartInstances.receitas = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: Object.keys(receitaCount),
                    datasets: [{
                        data: Object.values(receitaCount),
                        backgroundColor: ['#3498db', '#e74c3c', '#2ecc71']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Gr√°fico 3: Tanques
            const tanqueCount = {};
            data.forEach(d => {
                if (d.tanque) tanqueCount[d.tanque] = (tanqueCount[d.tanque] || 0) + 1;
            });

            const ctx3 = document.getElementById('chartTanques').getContext('2d');
            chartInstances.tanques = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: Object.keys(tanqueCount).sort(),
                    datasets: [{
                        label: 'Quantidade',
                        data: Object.values(tanqueCount),
                        backgroundColor: '#9b59b6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            // Gr√°fico 4: Produ√ß√£o
            const producaoCount = {};
            data.forEach(d => {
                if (d.producao) producaoCount[d.producao] = (producaoCount[d.producao] || 0) + 1;
            });

            const ctx4 = document.getElementById('chartProducao').getContext('2d');
            chartInstances.producao = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: Object.keys(producaoCount).sort((a, b) => {
                        const numA = parseInt(a);
                        const numB = parseInt(b);
                        if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                        return a.localeCompare(b);
                    }),
                    datasets: [{
                        label: 'Quantidade',
                        data: Object.values(producaoCount),
                        backgroundColor: '#1abc9c'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });

            // Gr√°fico 5: Temperaturas
            const ctx5 = document.getElementById('chartTemperaturas').getContext('2d');
            chartInstances.temperaturas = new Chart(ctx5, {
                type: 'line',
                data: {
                    labels: sortedData.map(d => new Date(d.data + 'T00:00:00').toLocaleDateString('pt-PT')),
                    datasets: [{
                        label: 'T. Coagula√ß√£o (¬∞C)',
                        data: sortedData.map(d => d.tempCoagulacao),
                        borderColor: '#e67e22',
                        backgroundColor: 'rgba(230, 126, 34, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'T. Lavagem (¬∞C)',
                        data: sortedData.map(d => d.tempLavagem),
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Gr√°fico 6: Fermentos
            const fermentoCount = {};
            data.forEach(d => {
                fermentoCount[d.fermento] = (fermentoCount[d.fermento] || 0) + 1;
            });

            const ctx6 = document.getElementById('chartFermentos').getContext('2d');
            chartInstances.fermentos = new Chart(ctx6, {
                type: 'bar',
                data: {
                    labels: Object.keys(fermentoCount),
                    datasets: [{
                        label: 'Quantidade',
                        data: Object.values(fermentoCount),
                        backgroundColor: '#16a085'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } }
                }
            });

            // Gr√°fico 7: R√°cios
            const racioCount = {};
            data.forEach(d => {
                racioCount[d.racio] = (racioCount[d.racio] || 0) + 1;
            });

            const ctx7 = document.getElementById('chartRacios').getContext('2d');
            chartInstances.racios = new Chart(ctx7, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(racioCount),
                    datasets: [{
                        data: Object.values(racioCount),
                        backgroundColor: ['#f39c12', '#d35400', '#c0392b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Gr√°fico 8: Status PH
            const phOk = data.filter(d => d.ph === 'OK').length;
            const phNaoOk = data.length - phOk;

            const ctx8 = document.getElementById('chartPH').getContext('2d');
            chartInstances.ph = new Chart(ctx8, {
                type: 'pie',
                data: {
                    labels: ['PH OK', 'PH com Valor'],
                    datasets: [{
                        data: [phOk, phNaoOk],
                        backgroundColor: ['#27ae60', '#e67e22']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // An√°lise comparativa de PH
        function displayPHComparison(data) {
            const phOkData = data.filter(d => d.ph === 'OK');
            const phNokData = data.filter(d => d.ph !== 'OK');

            if (phNokData.length === 0) {
                const comparisonHtml = `
                    <div class="comparison-section">
                        <div class="comparison-title">
                            ‚úÖ An√°lise de Correla√ß√£o PH
                        </div>
                        <div style="text-align: center; padding: 20px; color: #27ae60; font-weight: 600;">
                            Todos os registos t√™m PH OK! N√£o h√° dados para compara√ß√£o.
                        </div>
                    </div>
                `;
                document.getElementById('chartsContainer').insertAdjacentHTML('beforebegin', comparisonHtml);
                return;
            }

            const avg = (arr) => arr.reduce((a, b) => a + b, 0) / arr.length;

            const okStats = {
                gordura: phOkData.length > 0 ? avg(phOkData.map(d => d.gordura)) : 0,
                proteina: phOkData.length > 0 ? avg(phOkData.map(d => d.proteina)) : 0,
                tempCoag: phOkData.length > 0 ? avg(phOkData.map(d => d.tempCoagulacao)) : 0,
                tempLav: phOkData.length > 0 ? avg(phOkData.map(d => d.tempLavagem)) : 0
            };

            const nokStats = {
                gordura: avg(phNokData.map(d => d.gordura)),
                proteina: avg(phNokData.map(d => d.proteina)),
                tempCoag: avg(phNokData.map(d => d.tempCoagulacao)),
                tempLav: avg(phNokData.map(d => d.tempLavagem))
            };

            const diff = {
                gordura: nokStats.gordura - okStats.gordura,
                proteina: nokStats.proteina - okStats.proteina,
                tempCoag: nokStats.tempCoag - okStats.tempCoag,
                tempLav: nokStats.tempLav - okStats.tempLav
            };

            const formatDiff = (value) => {
                const sign = value >= 0 ? '+' : '';
                const className = value >= 0 ? 'diff-positive' : 'diff-negative';
                return `<span class="${className}">${sign}${value.toFixed(2)}</span>`;
            };

            const comparisonHtml = `
                <div class="comparison-section">
                    <div class="comparison-title">
                        üîç An√°lise Comparativa: PH OK vs PH com Desvios
                    </div>
                    <p style="margin-bottom: 20px; color: #7f8c8d;">
                        Esta an√°lise compara os valores m√©dios dos par√¢metros quando o PH est√° OK (${phOkData.length} registos) 
                        versus quando o PH apresenta desvios (${phNokData.length} registos).
                    </p>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Par√¢metro</th>
                                <th class="ph-ok-col">PH OK<br><small>(${phOkData.length} registos)</small></th>
                                <th class="ph-nok-col">PH com Desvios<br><small>(${phNokData.length} registos)</small></th>
                                <th>Diferen√ßa</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="metric-name">Gordura (%)</td>
                                <td class="ph-ok-col">${okStats.gordura.toFixed(2)}%</td>
                                <td class="ph-nok-col">${nokStats.gordura.toFixed(2)}%</td>
                                <td>${formatDiff(diff.gordura)}</td>
                            </tr>
                            <tr>
                                <td class="metric-name">Prote√≠na (%)</td>
                                <td class="ph-ok-col">${okStats.proteina.toFixed(2)}%</td>
                                <td class="ph-nok-col">${nokStats.proteina.toFixed(2)}%</td>
                                <td>${formatDiff(diff.proteina)}</td>
                            </tr>
                            <tr>
                                <td class="metric-name">Temperatura Coagula√ß√£o (¬∞C)</td>
                                <td class="ph-ok-col">${okStats.tempCoag.toFixed(1)}¬∞C</td>
                                <td class="ph-nok-col">${nokStats.tempCoag.toFixed(1)}¬∞C</td>
                                <td>${formatDiff(diff.tempCoag)}</td>
                            </tr>
                            <tr>
                                <td class="metric-name">Temperatura Lavagem (¬∞C)</td>
                                <td class="ph-ok-col">${okStats.tempLav.toFixed(1)}¬∞C</td>
                                <td class="ph-nok-col">${nokStats.tempLav.toFixed(1)}¬∞C</td>
                                <td>${formatDiff(diff.tempLav)}</td>
                            </tr>
                        </tbody>
                    </table>

                    ${generatePHDistributionAnalysis(phNokData)}

                    <div style="margin-top: 25px;">
                        <canvas id="chartPHComparison" style="max-height: 400px;"></canvas>
                    </div>
                </div>
            `;

            const existingComparison = document.querySelector('.comparison-section');
            if (existingComparison) {
                existingComparison.remove();
            }
            document.getElementById('chartsContainer').insertAdjacentHTML('beforebegin', comparisonHtml);

            const ctx = document.getElementById('chartPHComparison').getContext('2d');
            chartInstances.phComparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Gordura (%)', 'Prote√≠na (%)', 'T. Coagula√ß√£o (¬∞C)', 'T. Lavagem (¬∞C)'],
                    datasets: [{
                        label: 'PH OK',
                        data: [okStats.gordura, okStats.proteina, okStats.tempCoag, okStats.tempLav],
                        backgroundColor: '#27ae60',
                        borderColor: '#229954',
                        borderWidth: 2
                    }, {
                        label: 'PH com Desvios',
                        data: [nokStats.gordura, nokStats.proteina, nokStats.tempCoag, nokStats.tempLav],
                        backgroundColor: '#e74c3c',
                        borderColor: '#c0392b',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Compara√ß√£o de Par√¢metros: PH OK vs PH com Desvios',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function generatePHDistributionAnalysis(phNokData) {
            if (phNokData.length === 0) return '';

            const byReceita = {};
            phNokData.forEach(d => {
                byReceita[d.receita] = (byReceita[d.receita] || 0) + 1;
            });

            const byTanque = {};
            phNokData.forEach(d => {
                if (d.tanque) byTanque[d.tanque] = (byTanque[d.tanque] || 0) + 1;
            });

            const byFermento = {};
            phNokData.forEach(d => {
                byFermento[d.fermento] = (byFermento[d.fermento] || 0) + 1;
            });

            const byRacio = {};
            phNokData.forEach(d => {
                byRacio[d.racio] = (byRacio[d.racio] || 0) + 1;
            });

            const formatDistribution = (obj) => {
                return Object.entries(obj)
                    .sort((a, b) => b[1] - a[1])
                    .map(([key, count]) => `<strong>${key}</strong>: ${count}`)
                    .join(' | ');
            };

            return `
                <div style="margin-top: 25px; padding: 20px; background: white; border-radius: 6px; border: 1px solid #e74c3c;">
                    <h4 style="color: #e74c3c; margin-bottom: 15px;">üìã Onde Ocorrem os Desvios de PH?</h4>
                    <div style="display: grid; gap: 12px; font-size: 14px;">
                        <div><strong>Por Receita:</strong> ${formatDistribution(byReceita)}</div>
                        ${Object.keys(byTanque).length > 0 ? `<div><strong>Por Tanque:</strong> ${formatDistribution(byTanque)}</div>` : ''}
                        <div><strong>Por Fermento:</strong> ${formatDistribution(byFermento)}</div>
                        <div><strong>Por R√°cio:</strong> ${formatDistribution(byRacio)}</div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
